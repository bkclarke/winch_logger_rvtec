<!doctype html>
{% extends "wwdb/base.html" %}
{% load static %}

{% block content %}

<h1>Winch Plots</h1>
<br>
<p><strong>Date range restricted to 1 week in demo version.</strong></p>
<br>
<form method="get" onsubmit="return validateDateRange();" class="form-inline">
    <div class="form-group mb-2">
        {{ form.start_date.label_tag }}
        {{ form.start_date }}
    </div>

    <div class="form-group mb-2 ml-3">
        {{ form.end_date.label_tag }}
        {{ form.end_date }}
    </div>

    <div class="form-group mb-2 ml-3">
        {{ form.winch }}
    </div>

    <button type="submit" class="btn btn-primary mb-2 ml-3">Filter Data</button>
</form>

<div id="container" style="width: 100%; height: 400px;"></div>
<br>
<br>
<div id="no-data-message" style="display: none; text-align: center; font-size: 20px; color: #303030;">
    No data during the dates entered for the selected winch.
</div>
<br>
<br>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var startDateInput = document.getElementById('start_date');
        var endDateInput = document.getElementById('end_date');

        var currentDate = new Date();
        var currentDateString = currentDate.toISOString().split('T')[0];
        var oneDayAgo = new Date();
        oneDayAgo.setDate(currentDate.getDate() - 1);
        var oneDayAgoString = oneDayAgo.toISOString().split('T')[0];

        if (startDateInput && endDateInput) {
            startDateInput.value = oneDayAgoString;
            endDateInput.value = currentDateString;
        }

        try {
            var data_tension = JSON.parse('{{ data_json_tension|escapejs }}');
            var data_payout = JSON.parse('{{ data_json_payout|escapejs }}');

            if (data_tension.length === 0 && data_payout.length === 0) {
                document.getElementById('container').style.display = 'none';
                document.getElementById('no-data-message').style.display = 'block';
                return; // Exit if there's no data
            } else {
                document.getElementById('no-data-message').style.display = 'none';
                document.getElementById('container').style.display = 'block';
            }

            var chart = Highcharts.chart('container', {
                chart: {
                    type: 'line',
                    zoomType: 'x',
                    events: {
                        load: function() {
                            updateMaxTensionPlotLine(this);
                        }
                    }
                },
                title: {
                    text: 'Tension, Payout vs. Time'
                },
                xAxis: {
                    type: 'datetime',
                    title: {
                        text: 'Date'
                    },
                    events: {
                        afterSetExtremes: function (e) {
                            updateMaxTensionPlotLine(this.chart);
                        }
                    }
                },
                yAxis: [{
                    title: {
                        text: 'Tension lbs'
                    },
                    labels: {
                        format: '{value} lbs'
                    }
                }, {
                    title: {
                        text: 'Payout (m)'
                    },
                    labels: {
                        format: '{value} m'
                    },
                    opposite: true
                }],
                series: [{
                    name: 'Tension',
                    type: 'line',
                    yAxis: 0,
                    data: data_tension.map(function (point) {
                        return [new Date(point.date).getTime(), point.value];
                    })
                }, {
                    name: 'Payout',
                    type: 'line',
                    yAxis: 1,
                    data: data_payout.map(function (point) {
                        return [new Date(point.date).getTime(), point.value];
                    })
                }]
            });

            function updateMaxTensionPlotLine(chart) {
                var xAxis = chart.xAxis[0];
                var min = xAxis.min;
                var max = xAxis.max;

                var visibleTensionData = data_tension.filter(function(point) {
                    var pointTime = new Date(point.date).getTime();
                    return pointTime >= min && pointTime <= max;
                });

                if (visibleTensionData.length > 0) {
                    var maxTensionData = visibleTensionData.reduce(function(prev, current) {
                        return (prev.value > current.value) ? prev : current;
                    });

                    var maxTensionValue = maxTensionData.value;
                    var maxTensionDate = new Date(maxTensionData.date).getTime();

                    xAxis.update({
                        plotLines: [{
                            color: 'rgba(255, 0, 0, 0.8)',
                            width: 2,
                            value: maxTensionDate,
                            label: {
                                text: 'Max Tension: ' + maxTensionValue,
                                style: {
                                    color: 'red'
                                },
                                align: 'left',
                                verticalAlign: 'bottom',
                                x: 10,
                                y: -20,
                                rotation: 0
                            }
                        }]
                    });
                } else {
                    xAxis.update({
                        plotLines: []
                    });
                }
            }
        } catch (e) {
            console.error('Error parsing or plotting data:', e);
        }
    });
</script>
<script type="text/javascript">
    function validateDateRange() {
        console.log("Validation function called"); // Add this line

        var startDateInput = document.getElementById('start_date').value;
        var endDateInput = document.getElementById('end_date').value;

        // Check if both fields are filled
        if (!startDateInput || !endDateInput) {
            alert("Please fill in both date fields.");
            return false; // Prevent form submission
        }

        var startDate = new Date(startDateInput);
        var endDate = new Date(endDateInput);
        var now = new Date(); // Current date

        // Check if either date is in the future
        if (startDate > now || endDate > now) {
            alert("Dates cannot be in the future.");
            return false; // Prevent form submission
        }

        // Check if end date is earlier than start date
        if (endDate < startDate) {
            alert("End date must be later than start date.");
            return false; // Prevent form submission
        }

        var oneWeekInMillis = 7 * 24 * 60 * 60 * 1000; // One week in milliseconds

        // Check if date range exceeds one week
        if (endDate - startDate > oneWeekInMillis) {
            alert("Date range cannot exceed one week.");
            return false; // Prevent form submission
        }

        return true; // Allow form submission
    }

</script>
{% endblock content %}
